#!/bin/bash

# =============================================
# INSTALADOR AUTOMÃTICO PARA BOT SSH + PROXY
# VersÃ£o: 3.5 (Otimizada para Debian)
# =============================================

# Cores para o terminal
VERMELHO='\033[1;31m'
VERDE='\033[1;32m'
AMARELO='\033[1;33m'
AZUL='\033[1;34m'
NC='\033[0m'

# FunÃ§Ã£o para verificar erros
verificar_erro() {
  if [ $? -ne 0 ]; then
    echo -e "${VERMELHO}âŒ Erro no passo: $1${NC}"
    echo -e "${AMARELO}ðŸ”„ Tentando corrigir...${NC}"
    
    # CorreÃ§Ãµes automÃ¡ticas para erros comuns
    case "$1" in
      "DependÃªncias Node.js")
        sudo apt remove --purge nodejs npm -y
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        sudo apt-get install -y nodejs
        ;;
      "Download do Bot")
        wget --no-check-certificate https://github.com/Marcelo1408/BOT_SCRIPT_SSH/raw/main/novobotssh.zip -O bot.zip
        ;;
      *)
        echo -e "${VERMELHO}âš ï¸ NÃ£o foi possÃ­vel corrigir automaticamente.${NC}"
        exit 1
        ;;
    esac
    
    return 0
  fi
}

# 1. Atualizar sistema e instalar dependÃªncias
echo -e "${AZUL}âš¡ Atualizando pacotes e instalando dependÃªncias...${NC}"
sudo apt update && sudo apt upgrade -y
sudo apt install -y \
  curl wget git unzip \
  build-essential python3 make gcc \
  libssh2-1-dev \
  net-tools iptables
verificar_erro "InstalaÃ§Ã£o de dependÃªncias"

# 2. Instalar Node.js 20.x
echo -e "${AZUL}âš¡ Instalando Node.js 20.x...${NC}"
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
verificar_erro "InstalaÃ§Ã£o do Node.js"

# 3. Instalar PM2
echo -e "${AZUL}âš¡ Instalando PM2...${NC}"
sudo npm install -g pm2
verificar_erro "InstalaÃ§Ã£o do PM2"

# 4. Baixar e extrair o Bot
echo -e "${AZUL}âš¡ Baixando o Bot SSH...${NC}"
mkdir -p ~/bot && cd ~/bot
wget -q --show-progress https://github.com/Marcelo1408/BOT_SCRIPT_SSH/raw/main/novobotssh.zip -O bot.zip
unzip -o bot.zip && rm -f bot.zip
verificar_erro "Download e extraÃ§Ã£o do Bot"

# 5. Instalar dependÃªncias do Bot
echo -e "${AZUL}âš¡ Instalando dependÃªncias do Bot...${NC}"
npm install --production
verificar_erro "InstalaÃ§Ã£o de dependÃªncias do Bot"

# 6. ConfiguraÃ§Ã£o do Bot
echo -e "${VERDE}ðŸ¤– ConfiguraÃ§Ã£o do Bot SSH:${NC}"
read -p "Digite o BOT_TOKEN do Telegram: " BOT_TOKEN
read -p "Digite o ADM_ID do Telegram: " ADM_ID

cat > .env <<EOF
BOT_TOKEN=$BOT_TOKEN
ADM_ID=$ADM_ID
SERVER_HOST=$(curl -s ifconfig.me)
SERVER_USER=admin
SERVER_PASSWORD=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 16)
SERVER_PORT=22
SSH_TIMEOUT=20000
PROXY_ENABLED=true
PROXY_HOST=127.0.0.1
PROXY_PORT=3128
EOF

# 7. Iniciar o Bot
echo -e "${AZUL}âš¡ Iniciando o Bot...${NC}"
pm2 start index.js --name "bot-ssh"
pm2 save
pm2 startup

# 8. FinalizaÃ§Ã£o
echo -e "${VERDE}"
echo "============================================="
echo "ðŸŽ‰ BOT SSH INSTALADO COM SUCESSO!"
echo "============================================="
echo -e "${NC}"
echo -e "${AMARELO}ðŸ” Dados de acesso:${NC}"
echo -e "IP do servidor: $(curl -s ifconfig.me)"
echo -e "UsuÃ¡rio SSH: admin"
echo -e "Senha SSH: ${SERVER_PASSWORD}"
echo -e "\n${AZUL}ðŸ“Œ Comandos Ãºteis:${NC}"
echo -e "Ver logs: pm2 logs bot-ssh"
echo -e "Reiniciar: pm2 restart bot-ssh"
echo -e "Status: pm2 list"
